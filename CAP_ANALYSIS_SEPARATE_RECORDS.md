# Система отдельных записей кап

## Что изменилось

Теперь **каждая капа создает отдельную запись** в базе данных и поиске!

### Пример:
**Сообщение:**
```
CAP 30 Aff - Rec : RU/KZ
CAP 20 Aff2 - Rec : AU/US
10-19
```

**Результат в поиске:**
1. **Первая запись:** CAP 30 Aff - Rec : RU/KZ (расписание: 10-19)
2. **Вторая запись:** CAP 20 Aff2 - Rec : AU/US (расписание: 10-19)

## Установка

### 1. Создание таблицы
```bash
php artisan migrate:caps
```

### 2. Анализ существующих сообщений
```bash
php artisan analyze:existing-messages --limit=1000
```

### 3. Тестирование
```bash
php artisan test:new-cap-system
```

## Как работает

### Автоматический анализ
- Каждое новое сообщение автоматически анализируется
- Если найдены капы, создаются отдельные записи
- Каждая капа = отдельная запись в базе данных

### Структура записи
- **Cap Amount:** Сумма капы
- **Affiliate:** Название аффилейта (без слова CAP)
- **Broker:** Название брокера
- **Geos:** Геолокации
- **Schedule:** Расписание работы
- **Total Amount:** Общий лимит

### Поиск
- Поиск работает по всем полям
- Каждая капа показывается отдельно
- Быстрый поиск по индексам

## Преимущества

1. **Отдельные записи** - каждая капа видна отдельно
2. **Быстрый поиск** - индексы в базе данных
3. **Точный анализ** - правильное извлечение аффилейтов
4. **Автоматическое обновление** - новые сообщения анализируются автоматически

## Исправления

- ✅ Каждая капа отображается отдельно
- ✅ Исправлено извлечение названий аффилейтов
- ✅ Глобальное расписание применяется ко всем капам
- ✅ Быстрый поиск по базе данных
- ✅ Автоматический анализ новых сообщений 