# Обновление логики обработки пустых полей

## Проблема
Система не корректно обрабатывала пустые поля в сообщениях. Поля могут быть:
- Отсутствующими
- Пустыми (только пробелы)
- Содержать символ "-" (что означает отсутствие значения)

## Решение
Добавлена функция `isEmpty()` для проверки пустых значений и обновлена логика всех полей.

### Функция isEmpty()
```php
private function isEmpty($value)
{
    if ($value === null) return true;
    $trimmed = trim($value);
    return $trimmed === '' || $trimmed === '-';
}
```

### Правила обработки пустых полей

1. **Total**: 
   - Пустое/"-" → бесконечность (-1)
   - Число → это число

2. **Schedule**: 
   - Пустое/"-" → 24/7 (по умолчанию)
   - Значение → это значение

3. **Date**: 
   - Пустое/"-" → бесконечность (null)
   - Значение → это значение (с добавлением года если нужно)

4. **Language**: 
   - Пустое/"-" → "en" (по умолчанию)
   - Значение → это значение

5. **Funnel**: 
   - Пустое/"-" → null
   - Значение → это значение

6. **Pending ACQ / Freeze status**: 
   - Пустое/"-" → false
   - Yes/True/1/Да → true
   - Остальное → false

7. **Geo**: 
   - Пустое/"-" → игнорируется
   - Значение → парсится и разделяется

8. **Affiliate / Recipient**: 
   - Пустое/"-" → игнорируется (обязательные поля)
   - Значение → это значение

## Примеры

### Пример 1: Полностью пустые опциональные поля
```
Affiliate: TestAff
Recipient: TestRec
Cap: 15
Total: 
Geo: US
Language: 
Funnel: 
Schedule: 
Date: 
Pending ACQ: 
Freeze status on ACQ: 
```
Результат: Total=бесконечность, Language="en", Schedule=24/7, Date=бесконечность, Funnel=null, Pending ACQ=false, Freeze=false

### Пример 2: Поля со значением "-"
```
Affiliate: TestAff
Recipient: TestRec
Cap: 10
Total: -
Geo: DE
Language: -
Funnel: -
Schedule: -
Date: -
Pending ACQ: -
Freeze status on ACQ: -
```
Результат: Total=бесконечность, Language="en", Schedule=24/7, Date=бесконечность, Funnel=null, Pending ACQ=false, Freeze=false

## Файлы изменены
- `app/Services/CapAnalysisService.php` - добавлена функция isEmpty() и обновлена логика всех полей
- `app/Console/Commands/UpdateToNewCapFormat.php` - добавлен тест с пустыми полями
- `NEW_CAP_FORMAT_README.md` - обновлена документация с новыми правилами

## Тестирование
Добавлен тест в команде `UpdateToNewCapFormat` для проверки корректной обработки пустых полей и значений "-". 

# Сброс полей до значений по умолчанию

## Описание

Система теперь поддерживает сброс необязательных полей до значений по умолчанию при отправке пустых значений в сообщении.

## Как это работает

Когда поле указано в сообщении, но пустое (например, `Total:`), система сбрасывает это поле до значения по умолчанию. Это позволяет легко "очищать" поля без создания нового сообщения.

### Поведение системы

1. **Поле не указано в сообщении** → Поле остается без изменений
2. **Поле указано и не пустое** → Поле обновляется новым значением
3. **Поле указано но пустое** → Поле сбрасывается до значения по умолчанию

## Значения по умолчанию

| Поле | Значение по умолчанию | Описание |
|------|---------------------|----------|
| `Total` | `-1` | Бесконечность |
| `Schedule` | `24/7` | Круглосуточная работа |
| `Date` | `null` | Бессрочная капа |
| `Language` | `en` | Английский язык |
| `Funnel` | `null` | Без воронки |
| `Pending ACQ` | `false` | Не ожидает подтверждения |
| `Freeze status` | `false` | Не заморожена |

## Примеры использования

### Сброс Total до бесконечности

```
Affiliate: G06
Recipient: TMedia
Geo: DE
CAP: 20
Total:
```

Результат: `total_amount` установится в `-1` (бесконечность)

### Сброс языка до английского

```
Affiliate: G06
Recipient: TMedia
Geo: DE
CAP: 20
Language:
```

Результат: `language` установится в `en`

### Сброс нескольких полей одновременно

```
Affiliate: G06
Recipient: TMedia
Geo: DE
CAP: 20
Total:
Language:
Funnel:
Schedule:
Date:
```

Результат: Все указанные поля сбросятся до значений по умолчанию

## Запись в историю

При сбросе полей до значений по умолчанию:
- Старая версия записи сохраняется в `caps_history`
- Основная запись обновляется новыми значениями
- История содержит все изменения с временными метками

## Тестирование

Для тестирования функциональности используйте:

```bash
php artisan test:cap-history-system
```

Или standalone файл:
```bash
php test_cap_history_system.php
```

Тесты проверяют:
- Правильность сброса каждого поля
- Создание записей истории
- Неизменность полей, не указанных в сообщении

## Техническая реализация

### Изменения в CapAnalysisService

1. `isFieldSpecifiedInMessage()` - теперь определяет наличие поля независимо от того, пустое оно или нет
2. `getRawFieldValue()` - новый метод для получения сырого значения поля
3. `getFieldsToUpdate()` - обновлен для обработки пустых полей

### Логика обработки

```php
if ($this->isFieldSpecifiedInMessage($messageText, 'total')) {
    $rawTotalValue = $this->getRawFieldValue($messageText, 'total');
    $newTotal = $this->isEmpty($rawTotalValue) ? -1 : $newCapData['total_amount'];
    
    if ($existingCap->total_amount != $newTotal) {
        $updateData['total_amount'] = $newTotal;
    }
}
```

## Совместимость

Изменения полностью обратно совместимы:
- Существующие сообщения продолжают работать как раньше
- Поля, не указанные в сообщении, остаются неизменными
- Добавлена только новая функциональность для пустых полей 