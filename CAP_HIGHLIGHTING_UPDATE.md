# Обновление системы подсветки кап

## Что нового

Добавлена индикация того, какая именно часть сообщения была обработана для каждого блока анализа капы.

### Новые возможности

1. **Выделение обработанного текста** - для каждого блока анализа теперь показывается конкретная строка из сообщения, которая была обработана для этого блока
2. **Исправлена проблема с "неизвестным чатом"** - теперь правильно отображается название чата
3. **Улучшенная визуализация** - выделенный текст показывается в специальном блоке с оранжевым фоном

## Техническая информация

### Изменения в базе данных
- Добавлено поле `highlighted_text` в таблицу `caps` для хранения конкретного обработанного текста
- Миграция: `2024_12_19_000006_add_highlighted_text_to_caps_table.php`

### Изменения в коде
- Обновлен `CapAnalysisService` для сохранения выделенного текста
- Обновлен интерфейс для отображения выделенного текста
- Исправлено обращение к `chat->name` на `chat->display_name`

## Запуск обновления

### Автоматическое обновление
```bash
# Запустить bat файл
update-cap-highlighting.bat

# Или команду artisan
php artisan update:cap-highlighting
```

### Ручное обновление
```bash
# 1. Запустить миграцию
php artisan migrate

# 2. Перезапустить анализ всех сообщений
php artisan analyze:existing-messages
```

## Результат

После обновления в каждом блоке анализа капы будет показан дополнительный блок "Обработанный текст для этого блока" с конкретной строкой из сообщения, которая была использована для анализа.

Это помогает понять:
- Какая именно строка была обработана для каждой отдельной капы
- Откуда взяты данные для аффилейта, брокера и гео
- Как система разделила многострочные сообщения на отдельные записи

## Пример отображения

До обновления:
```
Капа: 30
Аффилейт: Aff
Брокер: Rec
Гео: RU, KZ
```

После обновления:
```
Капа: 30
Аффилейт: Aff
Брокер: Rec
Гео: RU, KZ
Обработанный текст для этого блока: CAP 30 Aff - Rec : RU/KZ
```

Это позволяет легко понять, из какой именно строки сообщения была извлечена каждая капа. 