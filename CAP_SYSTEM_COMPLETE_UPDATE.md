# Полная система управления капами с командами RUN, STOP, DELETE, RESTORE

## Обзор

Система управления капами теперь поддерживает полный жизненный цикл кап с четырьмя основными командами:
- **RUN** - запуск/возобновление капы
- **STOP** - остановка капы 
- **DELETE** - удаление в корзину
- **RESTORE** - восстановление из корзины

## Принцип работы с цепочкой сообщений

### Важная особенность: Привязка к изначальному сообщению
- **Все команды управления статусом (RUN, STOP, DELETE, RESTORE) всегда привязываются к изначальному сообщению с капой**
- **Все обновления через упрощенный формат также привязываются к изначальному сообщению**
- Не важно, на какое сообщение в цепочке вы отвечаете - система автоматически найдет изначальную капу
- В базе данных `message_id` капы всегда остается ID изначального сообщения с капой
- Это позволяет управлять капой из любого места в цепочке reply-сообщений

### Пример цепочки команд
```
1. Сообщение с капой: "Affiliate: G06..."
2. Ответ: "Geo: AT\nCap: 25" (обновление - отвечаем на сообщение #1)
3. Ответ: "STOP" (команда - можно отвечать на сообщение #2, но система найдет капу из #1)
4. Ответ: "Geo: AT\nSchedule: 10:00/18:00" (обновление - отвечаем на #3, система найдет капу из #1)
5. Ответ: "RUN" (команда - отвечаем на #4, система найдет капу из #1)
```

**Все команды в этой цепочке будут работать с одной и той же капой из сообщения #1.**

## Статусы кап

### Статусы
- **RUN** - активная капа (по умолчанию)
- **STOP** - остановленная капа
- **DELETE** - удаленная капа (в корзине)

### Переходы между статусами
```
RUN ←→ STOP ←→ DELETE
     ↑         ↓
     ← RESTORE ←
```

## Команды управления

### 1. Полные команды
Команды с полными данными капы:
```
Affiliate: G06
Recipient: TMedia
Cap: 20
Geo: AT
RUN
```

```
Affiliate: G06
Recipient: TMedia
Cap: 20
Geo: AT
STOP
```

```
Affiliate: G06
Recipient: TMedia
Cap: 20
Geo: AT
DELETE
```

```
Affiliate: G06
Recipient: TMedia
Cap: 20
Geo: AT
RESTORE
```

### 2. Простые команды (через reply_to_message)
Отвечаете на сообщение с капой одним словом:
```
RUN
```

```
STOP
```

```
DELETE
```

```
RESTORE
```

## Логика работы команд

### Логика переходов
- **RUN**: можно применить только к капе со статусом STOP
- **STOP**: можно применить только к капе со статусом RUN
- **DELETE**: можно применить к капе со статусом RUN или STOP
- **RESTORE**: можно применить только к капе со статусом DELETE

### Особенности
- **RESTORE** автоматически меняет статус на RUN (капа становится активной)
- При **DELETE** highlighted_text не меняется (сохраняется исходный текст)
- При остальных командах highlighted_text обновляется

## Фильтрация и поиск

### Поведение по умолчанию
- В интерфейсе показываются капы со статусами RUN и STOP
- Капы со статусом DELETE скрыты по умолчанию
- При поиске дубликатов исключаются капы со статусом DELETE

### Фильтры в интерфейсе
В веб-интерфейсе доступны следующие фильтры по статусу:
- **Все (кроме удаленных)** - показывает RUN и STOP (по умолчанию)
- **Активные** - только RUN
- **Остановленные** - только STOP
- **Корзина (удаленные)** - только DELETE
- **Все (включая удаленные)** - все статусы

## Обновления через reply_to_message

### 1. Полное обновление капы (старый формат)
Для обновления через reply требуются все обязательные поля:
```
Affiliate: G06
Recipient: TMedia
Cap: 25
Geo: AT
Schedule: 10:00-18:00
```

### 2. Упрощенное обновление капы (новый формат)
**Для обновления через reply требуется только Geo + поля для обновления:**
```
Geo: AT
Cap: 25
Schedule: 10:00-18:00
```

### Принцип работы упрощенного обновления

#### Обязательные требования:
- Сообщение должно быть **reply** на сообщение с капой
- Обязательно указать **Geo** (для проверки соответствия с оригинальной капой)
- Geo должен **совпадать** с оригинальной капой

#### Логика обработки:
1. Система находит оригинальную капу через цепочку reply_to_message
2. Проверяет, что указанный Geo совпадает с оригинальной капой
3. Обновляет **только указанные поля** (остальные остаются без изменений)
4. Поддерживает **сброс полей** до значений по умолчанию (пустые поля)

#### Поддерживаемые поля для обновления:
- `Cap:` - лимит капы
- `Total:` - общий лимит
- `Schedule:` - расписание работы
- `Date:` - дата окончания
- `Language:` - язык
- `Funnel:` - воронка
- `Pending ACQ:` - ожидание подтверждения
- `Freeze status on ACQ:` - заморозка при подтверждении

### Примеры упрощенного обновления

#### Пример 1: Обновление лимита и расписания
**Исходная капа:**
```
Affiliate: G06
Recipient: TMedia
Cap: 20
Geo: AT
Schedule: 24/7
```

**Reply на сообщение выше:**
```
Geo: AT
Cap: 30
Schedule: 10:00/18:00
```

**Результат:** Лимит изменен на 30, расписание на 10:00/18:00, остальные поля остаются прежними.

#### Пример 2: Сброс полей до значений по умолчанию
**Reply на сообщение с капой:**
```
Geo: AT
Total:
Schedule:
Language:
```

**Результат:** Total сброшен до бесконечности (-1), Schedule до 24/7, Language до 'en'.

#### Пример 3: Обновление через цепочку reply
```
1. Исходная капа: "Affiliate: G06..."
2. Reply: "Geo: AT\nCap: 25" (первое обновление)
3. Reply на сообщение #2: "Geo: AT\nSchedule: 10:00/18:00" (второе обновление)
```

**Результат:** Все обновления применяются к исходной капе из сообщения #1.

### Обработка ошибок

#### Ошибки упрощенного обновления:
- **"Geo обязателен для обновления капы"** - не указан Geo
- **"Капа не найдена в сообщении, на которое отвечаете"** - reply на сообщение без капы
- **"Нельзя обновить капу со статусом DELETE"** - попытка обновить удаленную капу
- **"Geo не совпадает с оригинальной капой"** - указан неправильный Geo

#### Преимущества упрощенного формата:
1. **Быстрота** - не нужно указывать все поля повторно
2. **Безопасность** - невозможно случайно создать новую капу
3. **Гибкость** - можно обновить только нужные поля
4. **Сброс полей** - легко сбросить поля до значений по умолчанию

## История изменений

### Автоматическое сохранение
- Каждое изменение статуса создает запись в истории
- Каждое обновление полей создает запись в истории
- История содержит полное состояние капы до изменения

### Таблица caps_history
Содержит все поля из таблицы caps плюс:
- `cap_id` - связь с основной капой
- `archived_at` - время архивирования

## Примеры использования

### Полный цикл работы с капой

1. **Создание капы**
```
Affiliate: G06
Recipient: TMedia
Cap: 20
Geo: AT
Schedule: 24/7
```

2. **Остановка капы**
Отвечаете на сообщение с капой:
```
STOP
```

3. **Возобновление капы**
Отвечаете на сообщение с капой:
```
RUN
```

4. **Удаление капы**
Отвечаете на сообщение с капой:
```
DELETE
```

5. **Восстановление из корзины**
Отвечаете на сообщение с капой:
```
RESTORE
```

### Обновление капы
1. **Создание капы**
```
Affiliate: G06
Recipient: TMedia
Cap: 20
Geo: AT
```

2. **Обновление лимита**
Отвечаете на сообщение с капой:
```
Cap: 25
Geo: AT
```

## Интерфейс

### Отображение статуса
В веб-интерфейсе статус каждой капы показывается с цветовой индикацией:
- **✅ АКТИВНАЯ** (зеленый) - RUN
- **⏸️ ОСТАНОВЛЕНА** (оранжевый) - STOP
- **🗑️ УДАЛЕНА** (красный) - DELETE

### Фильтры
Добавлен фильтр "Статус" со следующими опциями:
- Все (кроме удаленных) - по умолчанию
- Активные
- Остановленные
- Корзина (удаленные)
- Все (включая удаленные)

## Технические детали

### Обновленные файлы
- `app/Services/CapAnalysisService.php` - основная логика
- `app/Models/Cap.php` - модель с новыми методами
- `database/migrations/2024_12_19_000010_add_status_to_caps_table.php` - статус кап
- `database/migrations/2024_12_19_000011_add_status_to_caps_history_table.php` - статус в истории
- `database/migrations/2024_12_19_000012_add_reply_to_message_id_to_messages_table.php` - reply_to_message
- `resources/views/cap-analysis.blade.php` - интерфейс с фильтрами
- `app/Http/Controllers/TelegramWebhookController.php` - обработка reply_to_message

### Новые методы в Cap модели
- `updateStatus($status)` - обновление статуса
- `isActive()`, `isStopped()`, `isDeleted()` - проверка статуса
- `scopeActive()`, `scopeNotDeleted()` - скоупы для запросов

### Новые методы в CapAnalysisService
- `isStatusCommand($messageText)` - проверка команды статуса
- `processStatusCommand($messageId, $messageText)` - обработка команды статуса
- `getFieldsToUpdate($cap, $messageText)` - определение полей для обновления

## Тестирование

### Тестовая команда
```bash
php artisan test:cap-status-system
```

Команда протестирует:
- Создание кап со статусом RUN
- Команды STOP, RUN, DELETE, RESTORE
- Простые команды через reply_to_message
- Обновление кап через reply_to_message
- Фильтрацию по статусам
- Создание истории изменений
- Обработку ошибок

### Тестовые сценарии
1. Создание капы → STOP → RUN → DELETE → RESTORE
2. Обновление капы через reply_to_message
3. Проверка фильтрации
4. Проверка истории изменений
5. Обработка ошибочных команд

## Безопасность

### Проверки
- Команды RUN/STOP/DELETE/RESTORE проверяют текущий статус
- Нельзя применить неподходящую команду к капе
- При простых командах обязательно наличие reply_to_message_id
- При обновлении через reply проверяется соответствие гео

### Ошибки
- Четкие сообщения об ошибках для пользователей
- Логирование всех операций
- Валидация входных данных

## Совместимость

### Обратная совместимость
- Все существующие капы получают статус RUN по умолчанию
- Старые команды продолжают работать
- API сохраняет совместимость

### Миграции
- Добавлены новые поля в существующие таблицы
- Установлены значения по умолчанию
- Созданы необходимые индексы

## Заключение

Система управления капами теперь предоставляет полный набор инструментов для управления жизненным циклом кап:
- Интуитивные команды управления
- Удобный веб-интерфейс с фильтрацией
- Полная история изменений
- Безопасность и валидация
- Обратная совместимость

Система готова к использованию в продакшене! 