# Обновление системы кап через Reply to Message

## Обзор

Добавлена функциональность использования **reply_to_message** для управления капами. Теперь можно:

1. **Обновлять капы** отвечая на сообщение с капой (требуется только указать Geo)
2. **Менять статус** простыми командами `STOP` или `DELETE` в ответ на сообщение с капой

## Новые возможности

### 1. Обновление кап через Reply

**Старый способ** (все поля обязательны):
```
Affiliate: G06
Recipient: TMedia
Cap: 25
Geo: AT
Schedule: 10:00-18:00
```

**Новый способ** (reply на сообщение с капой, только Geo обязательно):
```
Cap: 25
Geo: AT
Schedule: 10:00-18:00
```

### 2. Управление статусом через Reply

**Старый способ**:
```
Affiliate: G06
Recipient: TMedia
Cap: 20
Geo: AT
STOP
```

**Новый способ** (reply на сообщение с капой):
```
STOP
```

или

```
DELETE
```

## Логика работы

### Обновление кап

1. **С reply_to_message**: Система ищет капу по ID сообщения, на которое отвечают
   - Проверяет что указанное Geo совпадает с гео в найденной капе
   - Если совпадает - обновляет капу
   - Если не совпадает - создает новую капу (как обычно)

2. **Без reply_to_message**: Работает по старой логике поиска дубликатов

### Команды статуса

1. **С reply_to_message**: Ищет капу по ID сообщения
   - Не требует указания всех полей
   - Проверяет что капа найдена и не удалена

2. **Без reply_to_message**: Требует указания всех полей как раньше

## Изменения в базе данных

### Таблица `messages`
- Добавлено поле `reply_to_message_id` (bigint, nullable)
- Добавлен индекс на `reply_to_message_id`

### Связи в модели Message
```php
// Сообщение, на которое отвечают
public function replyToMessage()
{
    return $this->belongsTo(Message::class, 'reply_to_message_id');
}

// Ответы на это сообщение
public function replies()
{
    return $this->hasMany(Message::class, 'reply_to_message_id');
}
```

## Изменения в коде

### TelegramWebhookController
- Обработка `reply_to_message` из Telegram API
- Поиск оригинального сообщения в базе данных
- Сохранение `reply_to_message_id` в таблицу messages

### CapAnalysisService
- Проверка `reply_to_message_id` при обработке кап
- Приоритет поиска по ID сообщения над поиском дубликатов
- Обязательная проверка совпадения Geo при обновлении через reply

## Примеры использования

### Пример 1: Создание капы
```
Affiliate: G06
Recipient: TMedia
Cap: 20
Geo: AT
Schedule: 24/7
```

### Пример 2: Обновление через reply (простое)
**Ответ на сообщение выше:**
```
Cap: 25
Geo: AT
```
**Результат**: Лимит обновлен с 20 до 25

### Пример 3: Обновление через reply (расширенное)
**Ответ на сообщение с капой:**
```
Cap: 30
Geo: AT
Schedule: 09:00-17:00
Total: 100
Language: ru
```
**Результат**: Обновлены все указанные поля

### Пример 4: Остановка капы
**Ответ на сообщение с капой:**
```
STOP
```
**Результат**: Капа получает статус STOP

### Пример 5: Удаление капы
**Ответ на сообщение с капой:**
```
DELETE
```
**Результат**: Капа получает статус DELETE

### Пример 6: Создание новой капы при неправильном Geo
**Исходная капа:**
```
Affiliate: G06
Recipient: TMedia
Cap: 20
Geo: AT
```

**Ответ с другим Geo:**
```
Cap: 25
Geo: DE
```
**Результат**: Создается новая капа для DE (старая для AT остается без изменений)

## Валидация и ошибки

### Обновление кап
- **Обязательное поле**: `Geo` (должно совпадать с капой в исходном сообщении)
- **Ошибка**: Если Geo не совпадает - создается новая капа

### Команды статуса
- **Требование**: reply_to_message на сообщение с капой
- **Ошибки**:
  - "Команда должна быть ответом на сообщение с капой"
  - "Капа не найдена в сообщении, на которое отвечаете"

## Совместимость

- Старые команды продолжают работать без изменений
- Новая функциональность не ломает существующую логику
- Можно использовать оба способа одновременно

## Преимущества

1. **Удобство**: Не нужно указывать все поля повторно
2. **Безопасность**: Невозможно случайно обновить не ту капу
3. **Скорость**: Быстрые команды STOP/DELETE
4. **Контекст**: Связь между исходным сообщением и командой

## Миграции

```bash
# Новая миграция
php artisan migrate

# Файл миграции
2024_12_19_000012_add_reply_to_message_id_to_messages_table.php
```

## Тестирование

```bash
# Запуск полного теста системы
php artisan test:cap-status-system
```

Тест проверяет:
- Создание кап
- Обновление через reply_to_message
- Команды STOP/DELETE через reply
- Обработку ошибок
- Совместимость со старой логикой

## Технические детали

### Telegram Bot API
При получении сообщения с reply_to_message, в JSON приходит:
```json
{
  "message": {
    "message_id": 123,
    "reply_to_message": {
      "message_id": 122,
      ...
    },
    ...
  }
}
```

### Поиск исходного сообщения
```php
if (isset($messageData['reply_to_message'])) {
    $replyToTelegramMessageId = $messageData['reply_to_message']['message_id'];
    $replyToMessage = Message::where('telegram_message_id', $replyToTelegramMessageId)
                           ->where('chat_id', $chatModel->id)
                           ->first();
    if ($replyToMessage) {
        $replyToMessageId = $replyToMessage->id;
    }
}
```

### Поиск капы по reply
```php
if ($currentMessage && $currentMessage->reply_to_message_id) {
    $existingCap = Cap::where('message_id', $currentMessage->reply_to_message_id)
                     ->whereIn('status', ['RUN', 'STOP'])
                     ->first();
                     
    // Проверяем совпадение Geo
    if ($existingCap && !in_array($geo, $existingCap->geos)) {
        $existingCap = null;
    }
}
```

Система готова к использованию и значительно упрощает управление капами! 