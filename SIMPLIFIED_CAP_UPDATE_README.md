# Упрощенное обновление кап через Reply

## Обзор

Добавлена новая функциональность **упрощенного обновления кап через reply**, которая позволяет обновлять капы, указав только `Geo:` и поля для обновления, не требуя всех обязательных полей.

## Принцип работы

### Старый способ (полное обновление)
```
Affiliate: G06
Recipient: TMedia
Cap: 25
Geo: AT
Schedule: 10:00-18:00
```

### Новый способ (упрощенное обновление)
**Reply на сообщение с капой:**
```
Geo: AT
Cap: 25
Schedule: 10:00-18:00
```

## Требования

1. **Обязательно**: Сообщение должно быть **reply** на сообщение с капой
2. **Обязательно**: Указать `Geo:` для проверки соответствия
3. **Проверка**: Geo должен совпадать с оригинальной капой
4. **Статус**: Капа должна иметь статус RUN или STOP (не DELETE)

## Поддерживаемые поля

- `Cap:` - лимит капы
- `Total:` - общий лимит
- `Schedule:` - расписание работы
- `Date:` - дата окончания
- `Language:` - язык
- `Funnel:` - воронка
- `Pending ACQ:` - ожидание подтверждения
- `Freeze status on ACQ:` - заморозка при подтверждении

## Примеры использования

### Пример 1: Обновление лимита
**Исходная капа:**
```
Affiliate: G06
Recipient: TMedia
Cap: 20
Geo: AT
Schedule: 24/7
```

**Reply:** 
```
Geo: AT
Cap: 30
```

**Результат:** Лимит изменен на 30, остальные поля остаются прежними.

### Пример 2: Обновление расписания
**Reply на сообщение с капой:**
```
Geo: AT
Schedule: 10:00/18:00 GMT+03:00
```

**Результат:** Расписание изменено, остальные поля остаются прежними.

### Пример 3: Сброс полей
**Reply на сообщение с капой:**
```
Geo: AT
Total:
Schedule:
Language:
```

**Результат:** 
- Total сброшен до бесконечности (-1)
- Schedule сброшен до 24/7
- Language сброшен до 'en'

### Пример 4: Цепочка reply
```
1. Исходная капа: "Affiliate: G06..."
2. Reply: "Geo: AT\nCap: 25"
3. Reply на сообщение #2: "Geo: AT\nSchedule: 10:00/18:00"
```

**Результат:** Оба обновления применяются к исходной капе из сообщения #1.

## Обработка ошибок

### Возможные ошибки:
- `"Geo обязателен для обновления капы"` - не указан Geo
- `"Капа не найдена в сообщении, на которое отвечаете"` - reply на сообщение без капы
- `"Нельзя обновить капу со статусом DELETE"` - попытка обновить удаленную капу
- `"Geo не совпадает с оригинальной капой"` - указан неправильный Geo

## Значения по умолчанию

При указании пустого поля (например, `Total:`), поле сбрасывается до значения по умолчанию:

| Поле | Значение по умолчанию |
|------|---------------------|
| `Total:` | `-1` (бесконечность) |
| `Schedule:` | `24/7` |
| `Date:` | `null` (бесконечность) |
| `Language:` | `en` |
| `Funnel:` | `null` |
| `Pending ACQ:` | `false` |
| `Freeze status on ACQ:` | `false` |

## Преимущества

1. **Быстрота** - не нужно указывать все поля повторно
2. **Безопасность** - невозможно случайно создать новую капу
3. **Гибкость** - можно обновить только нужные поля
4. **Сброс полей** - легко сбросить поля до значений по умолчанию
5. **Цепочка reply** - можно отвечать на любое сообщение в цепочке

## Совместимость

- Полностью совместимо со старым форматом
- Старые команды продолжают работать
- Можно использовать оба способа одновременно

## Тестирование

```bash
# Запуск теста
test-simplified-cap-update.bat

# Или через artisan
php artisan test:cap-status-system
```

## Техническая реализация

### Новые методы в CapAnalysisService:
- `isUpdateCapMessage()` - определяет сообщения для упрощенного обновления
- `processCapUpdate()` - обрабатывает упрощенное обновление

### Логика определения:
- Есть `Geo:` (обязательно)
- Нет `Affiliate:` или `Recipient:` (отличие от полного формата)
- Сообщение является reply на сообщение с капой

### Алгоритм обработки:
1. Найти оригинальную капу через цепочку reply_to_message
2. Проверить совпадение Geo
3. Парсить указанные поля
4. Обновить только изменившиеся поля
5. Сохранить в историю изменений

## Статус

✅ **Готово к использованию**
- Логика реализована
- Тесты добавлены
- Документация обновлена
- Поддержка цепочки reply
- Обработка ошибок 