# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∫–∞–ø - –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞

## üéØ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

–°–∏—Å—Ç–µ–º–∞ –∫–∞–ø –±—ã–ª–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–æ–≤—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏–π. **–ë–æ–ª—å—à–µ –Ω–µ—Ç –ø–æ–∏—Å–∫–∞ —Å–ª–æ–≤–∞ "cap" –∏ —Å–∏–Ω–æ–Ω–∏–º–æ–≤** - —Å–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.

## üìã –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π

### –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
```
Affiliate: G06
Recipient: TMedia
Cap: 15
Total: 
Geo: IE
Language: en
Funnel: 
Schedule: 10:00/18:00 GMT+03:00
Date: 
Pending ACQ: No
Freeze status on ACQ: No
```

### –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–ø–∏—Å–∫–æ–≤:
```
Affiliate: G06, aff2        # –°–æ–∑–¥–∞—Å—Ç 2 –∑–∞–ø–∏—Å–∏
Recipient: TMedia, brok2    # –°–æ–∑–¥–∞—Å—Ç 2 –∑–∞–ø–∏—Å–∏
# –í—Å–µ–≥–æ: 4 –∑–∞–ø–∏—Å–∏ (–∫–∞–∂–¥–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è)
```

## üóÉÔ∏è –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

–î–æ–±–∞–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ª—è –≤ —Ç–∞–±–ª–∏—Ü—É `caps`:
- `language` (string) - –Ø–∑—ã–∫
- `funnel` (string) - –í–æ—Ä–æ–Ω–∫–∞  
- `pending_acq` (boolean) - –û–∂–∏–¥–∞–Ω–∏–µ ACQ
- `freeze_status_on_acq` (boolean) - –ó–∞–º–æ—Ä–æ–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ ACQ
- `recipient_name` (–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ –∏–∑ `broker_name`) - –ü–æ–ª—É—á–∞—Ç–µ–ª—å

## üîß –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **–ú–∏–≥—Ä–∞—Ü–∏—è**: `database/migrations/2024_12_19_000007_add_new_fields_to_caps_table.php`
- **–ú–æ–¥–µ–ª—å**: –û–±–Ω–æ–≤–ª–µ–Ω–∞ `app/Models/Cap.php`

### 2. –õ–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞
- **–°–µ—Ä–≤–∏—Å**: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω `app/Services/CapAnalysisService.php`
- **–ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã**:
  - `isStandardCapMessage()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
  - `parseStandardCapMessage()` - –ø–∞—Ä—Å–∏–Ω–≥ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å–ø–∏—Å–∫–æ–≤
  - `analyzeAndSaveCapMessage()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Å—Å–∏–≤–∞ –∑–∞–ø–∏—Å–µ–π

### 3. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- **–ö–≤–∞–¥—Ä–∞—Ç–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞**:
  - ‚ùå –£–±—Ä–∞–Ω –∫–≤–∞–¥—Ä–∞—Ç–∏–∫ "–°–ª–æ–≤–æ CAP"
  - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∏ "–Ø–∑—ã–∫" –∏ "–í–æ—Ä–æ–Ω–∫–∞"
  - ‚úÖ –û–±—ä–µ–¥–∏–Ω–µ–Ω—ã "Pending ACQ" –∏ "Freeze status" –≤ –æ–¥–∏–Ω: "Freeze Yes/No"

- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**:
  - –ò–∑–º–µ–Ω–µ–Ω–∞ —Å "–° –∫–∞–ø–æ–π" –Ω–∞ "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç"
  - –¢–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ

### 4. –≠–∫—Å–ø–æ—Ä—Ç
- **CSV**: –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–æ–ª—è, —É–±—Ä–∞–Ω–æ "–°–ª–æ–≤–æ CAP"

## üìë –ü—Ä–∞–≤–∏–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
- `Affiliate` - –ù–∞–∑–≤–∞–Ω–∏–µ –∞—Ñ—Ñ–∏–ª–µ–π—Ç–∞ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
- `Recipient` - –ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)  
- `Cap` - –ó–Ω–∞—á–µ–Ω–∏–µ –∫–∞–ø—ã

### –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- **Total**: –ï—Å–ª–∏ –ø—É—Å—Ç–æ–µ ‚Üí –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å (-1)
- **Schedule**: –ï—Å–ª–∏ –ø—É—Å—Ç–æ–µ ‚Üí 24/7
- **Date**: –ï—Å–ª–∏ –ø—É—Å—Ç–æ–µ ‚Üí –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å (null)
- **Language**: –ï—Å–ª–∏ –ø—É—Å—Ç–æ–µ ‚Üí null
- **Funnel**: –ï—Å–ª–∏ –ø—É—Å—Ç–æ–µ ‚Üí null
- **Pending ACQ**: –ï—Å–ª–∏ –ø—É—Å—Ç–æ–µ ‚Üí false
- **Freeze status**: –ï—Å–ª–∏ –ø—É—Å—Ç–æ–µ ‚Üí false

### –û—Å–æ–±—ã–µ —Å–ª—É—á–∞–∏
- **Cap —Å–æ —Å–ª–µ—à–µ–º**: `Cap: 15/150` ‚Üí Cap=15, Total=–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å
- **Geo**: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –∑–∞–ø—è—Ç–æ–π, –ø—Ä–æ–±–µ–ª–∞, —Å–ª–µ—à–∞
- **–°–ø–∏—Å–∫–∏**: –ê—Ñ—Ñ–∏–ª–µ–π—Ç—ã –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é —Å–æ–∑–¥–∞—é—Ç –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–∏–º–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π:

**–¢–µ—Å—Ç 1: –û–¥–∏–Ω–æ—á–Ω–∞—è –∫–∞–ø–∞**
```
Affiliate: G06
Recipient: TMedia
Cap: 15
Total: 
Geo: IE
Language: en
Funnel: 
Schedule: 10:00/18:00 GMT+03:00
Date: 
Pending ACQ: No
Freeze status on ACQ: No
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: 1 –∑–∞–ø–∏—Å—å

**–¢–µ—Å—Ç 2: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞—Ñ—Ñ–∏–ª–µ–π—Ç—ã**
```
Affiliate: G06, aff2
Recipient: TMedia
Cap: 20
Total: 200
Geo: IE, DE
Language: en
Funnel: Crypto
Schedule: 24/7
Date: 24.02
Pending ACQ: Yes
Freeze status on ACQ: No
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: 2 –∑–∞–ø–∏—Å–∏ (G06+TMedia, aff2+TMedia)

**–¢–µ—Å—Ç 3: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–∏**
```
Affiliate: G06
Recipient: TMedia, brok2
Cap: 30
Total: 
Geo: RU
Language: ru
Funnel: 
Schedule: 
Date: 
Pending ACQ: 
Freeze status on ACQ: 
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: 2 –∑–∞–ø–∏—Å–∏ (G06+TMedia, G06+brok2)

## üöÄ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

### 1. –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
php artisan migrate --force
```

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
```bash
php artisan update:new-cap-format --test
```

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ batch —Ñ–∞–π–ª–∞ (Windows)
```batch
update-to-new-cap-format.bat
```

## üìä –û—Ç–ª–∏—á–∏—è –æ—Ç —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã

| –ê—Å–ø–µ–∫—Ç | –°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞ | –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ |
|--------|----------------|---------------|
| –ü–æ–∏—Å–∫ | –°–ª–æ–≤–æ "cap" –∏ —Å–∏–Ω–æ–Ω–∏–º—ã | –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç |
| –ü–æ–ª—è | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä | –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏ |
| –ó–∞–ø–∏—Å–∏ | –û–¥–Ω–∞ –∑–∞–ø–∏—Å—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ | –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ |
| –õ–æ–≥–∏–∫–∞ | –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º | –°—Ç—Ä–æ–≥–∏–π –ø–∞—Ä—Å–∏–Ω–≥ –ø–æ–ª–µ–π |
| –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å | –ö–≤–∞–¥—Ä–∞—Ç–∏–∫ "–°–ª–æ–≤–æ CAP" | –ö–≤–∞–¥—Ä–∞—Ç–∏–∫–∏ "–Ø–∑—ã–∫", "–í–æ—Ä–æ–Ω–∫–∞", "Freeze" |

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

1. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –°—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –±—É–¥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è
2. **–ù–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏**: –°–ø–∏—Å–∫–∏ –∞—Ñ—Ñ–∏–ª–µ–π—Ç–æ–≤/–ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π —Å–æ–∑–¥–∞—é—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏
3. **–ü–æ–ª—è**: `broker_name` –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ –≤ `recipient_name`
4. **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å**: –ò–∑–º–µ–Ω–µ–Ω—ã –∫–≤–∞–¥—Ä–∞—Ç–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

## üîç –§–∞–π–ª—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

- `test_new_cap_parsing.php` - –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Ç–µ—Å—Ç –ø–∞—Ä—Å–µ—Ä–∞
- `NEW_CAP_FORMAT_README.md` - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞
- `update-to-new-cap-format.bat` - Batch —Ñ–∞–π–ª –¥–ª—è Windows

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ —Å –Ω–æ–≤—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–ø–∏—Å–∫–∏ –∞—Ñ—Ñ–∏–ª–µ–π—Ç–æ–≤ –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π, –≤–∫–ª—é—á–∞–µ—Ç –Ω–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ç–æ—á–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. 